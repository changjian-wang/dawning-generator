#!/bin/bash
# {{project_name}} 开发环境启动脚本 (Linux/macOS)
# 使用方法: chmod +x scripts/start-dev.sh && ./scripts/start-dev.sh

set -e

echo "========================================"
echo "  {{project_name}} 开发环境启动脚本"
echo "========================================"
echo ""

# 检查 Docker 是否安装
echo "[1/4] 检查 Docker..."
if ! command -v docker &> /dev/null; then
    echo "错误: Docker 未安装"
    echo "请先安装 Docker: https://docs.docker.com/get-docker/"
    exit 1
fi
echo "  Docker 已安装: $(docker --version)"

# 检查 Docker 是否正在运行
echo "[2/4] 检查 Docker 服务状态..."
if ! docker info &> /dev/null; then
    echo "错误: Docker 服务未运行"
    echo "请启动 Docker 服务"
    exit 1
fi
echo "  Docker 服务正在运行"

# 获取脚本所在目录
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# 启动 Docker Compose 服务
echo "[3/4] 启动数据库服务..."
cd "$PROJECT_DIR"
docker-compose up -d
echo "  数据库服务已启动"

# 等待数据库就绪
echo "[4/4] 等待数据库就绪..."
{{~ if database_type == "MySQL" ~}}
max_retries=30
retry_count=0
while [ $retry_count -lt $max_retries ]; do
    if docker exec {{project_name | string.downcase}}-mysql mysqladmin ping -h localhost --silent 2>/dev/null; then
        break
    fi
    retry_count=$((retry_count + 1))
    echo "  等待 MySQL 启动... ($retry_count/$max_retries)"
    sleep 2
done
if [ $retry_count -eq $max_retries ]; then
    echo "警告: MySQL 可能未完全就绪，请稍后重试"
else
    echo "  MySQL 已就绪"
fi
{{~ else if database_type == "PostgreSQL" ~}}
max_retries=30
retry_count=0
while [ $retry_count -lt $max_retries ]; do
    if docker exec {{project_name | string.downcase}}-postgres pg_isready -U postgres 2>/dev/null; then
        break
    fi
    retry_count=$((retry_count + 1))
    echo "  等待 PostgreSQL 启动... ($retry_count/$max_retries)"
    sleep 2
done
if [ $retry_count -eq $max_retries ]; then
    echo "警告: PostgreSQL 可能未完全就绪，请稍后重试"
else
    echo "  PostgreSQL 已就绪"
fi
{{~ else if database_type == "SqlServer" ~}}
max_retries=60
retry_count=0
while [ $retry_count -lt $max_retries ]; do
    if docker exec {{project_name | string.downcase}}-sqlserver /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "SqlServer@123456" -C -Q "SELECT 1" 2>/dev/null; then
        break
    fi
    retry_count=$((retry_count + 1))
    echo "  等待 SQL Server 启动... ($retry_count/$max_retries)"
    sleep 2
done
if [ $retry_count -eq $max_retries ]; then
    echo "警告: SQL Server 可能未完全就绪，请稍后重试"
else
    echo "  SQL Server 已就绪"
fi
{{~ else ~}}
echo "  SQLite 无需等待"
{{~ end ~}}

echo ""
echo "========================================"
echo "  开发环境已就绪!"
echo "========================================"
echo ""
echo "数据库连接信息:"
{{~ if database_type == "MySQL" ~}}
echo "  类型: MySQL"
echo "  主机: localhost:3306"
echo "  数据库: {{project_name | string.downcase}}_db"
echo "  用户名: app_user"
echo "  密码: app123456"
echo "  Root密码: root123456"
{{~ else if database_type == "PostgreSQL" ~}}
echo "  类型: PostgreSQL"
echo "  主机: localhost:5432"
echo "  数据库: {{project_name | string.downcase}}_db"
echo "  用户名: postgres"
echo "  密码: postgres123456"
{{~ else if database_type == "SqlServer" ~}}
echo "  类型: SQL Server"
echo "  主机: localhost,1433"
echo "  用户名: sa"
echo "  密码: SqlServer@123456"
{{~ else ~}}
echo "  类型: SQLite"
echo "  文件: ./{{project_name | string.downcase}}.db"
{{~ end ~}}
echo ""
echo "启动 API 服务:"
echo "  cd src/{{project_name}}.Api"
echo "  dotnet run"
echo ""
echo "停止服务:"
echo "  docker-compose down"
echo ""
